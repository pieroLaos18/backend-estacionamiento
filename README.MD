# Backend - Sistema de Estacionamiento

Backend para el sistema de gesti√≥n de estacionamiento con integraci√≥n MQTT para sensores ESP32 y API REST para el frontend.

## üöÄ Tecnolog√≠as

- **Node.js** + **Express** - Servidor y API REST
- **MySQL** - Base de datos relacional
- **MQTT** - Comunicaci√≥n con sensores ESP32 (HiveMQ)
- **dotenv** - Gesti√≥n de variables de entorno
- **CORS** - Habilitaci√≥n de peticiones cross-origin

---

## üìã Requisitos Previos

Antes de comenzar, aseg√∫rate de tener instalado:

- [Node.js](https://nodejs.org/) (v14 o superior)
- [MySQL](https://dev.mysql.com/downloads/mysql/) (v8.0 o superior)
- [Git](https://git-scm.com/downloads)

---

## ‚öôÔ∏è Instalaci√≥n

### 1. Clonar el repositorio

```bash
git clone https://github.com/pieroLaos18/backend-estacionamiento.git
cd backend-estacionamiento
```

### 2. Instalar dependencias

```bash
npm install
```

### 3. Configurar variables de entorno

Copia el archivo `.env_example` y ren√≥mbralo a `.env`:

```bash
cp .env_example .env
```

Luego edita el archivo `.env` con tus credenciales:

```env
# Configuraci√≥n de Base de Datos MySQL
DB_HOST=localhost
DB_USER=root
DB_PASSWORD=tu_password_mysql
DB_NAME=parking_system
DB_PORT=3306

# Puerto del servidor
PORT=3001

# Configuraci√≥n MQTT (HiveMQ Cloud)
MQTT_BROKER_URL=wss://tu-broker.hivemq.cloud:8884/mqtt
MQTT_USER=tu_usuario_mqtt
MQTT_PASSWORD=tu_password_mqtt
```

### 4. Crear la base de datos

Ejecuta el script de inicializaci√≥n de la base de datos:

```bash
node init-db.js
```

Este script crear√°:
- La base de datos `parking_system`
- Las tablas necesarias: `rates`, `parking_sessions`, `entry_queue`, `parking_spots`
- Datos iniciales de ejemplo

---

## üèÉ Ejecuci√≥n

### Iniciar el servidor

```bash
node server.js
```

El servidor estar√° corriendo en: `http://localhost:3001`

Deber√≠as ver el mensaje:
```
üöÄ Servidor backend corriendo en http://localhost:3001
```

---

## üì° API Endpoints

### **Tarifas**

| M√©todo | Endpoint | Descripci√≥n |
|--------|----------|-------------|
| `GET` | `/api/rates` | Obtener tarifas activas |
| `POST` | `/api/rates` | Actualizar tarifas |

### **Veh√≠culos**

| M√©todo | Endpoint | Descripci√≥n |
|--------|----------|-------------|
| `GET` | `/api/vehicles/active` | Obtener veh√≠culos actualmente estacionados |
| `POST` | `/api/vehicles/entry` | Registrar entrada de veh√≠culo |
| `POST` | `/api/vehicles/exit` | Registrar salida y pago |
| `POST` | `/api/vehicles/mark-exit` | Marcar hora de salida (pre-pago) |

### **Dashboard**

| M√©todo | Endpoint | Descripci√≥n |
|--------|----------|-------------|
| `GET` | `/api/dashboard` | Obtener m√©tricas del dashboard |
| `GET` | `/api/history` | Obtener historial de sesiones |

### **Cola de Entrada**

| M√©todo | Endpoint | Descripci√≥n |
|--------|----------|-------------|
| `GET` | `/api/queue` | Obtener cola de espera |
| `POST` | `/api/queue` | Agregar veh√≠culo a la cola |
| `DELETE` | `/api/queue/:id` | Remover veh√≠culo de la cola |
| `POST` | `/api/queue/:id/assign` | Marcar veh√≠culo como asignado |

---

## üìÅ Estructura del Proyecto

```
backend/
‚îú‚îÄ‚îÄ _esp32_/              # C√≥digo para sensores ESP32
‚îú‚îÄ‚îÄ node_modules/         # Dependencias (ignorado en git)
‚îú‚îÄ‚îÄ .env                  # Variables de entorno (ignorado en git)
‚îú‚îÄ‚îÄ .env_example          # Ejemplo de variables de entorno
‚îú‚îÄ‚îÄ .gitignore            # Archivos ignorados por git
‚îú‚îÄ‚îÄ db.js                 # Configuraci√≥n de conexi√≥n a MySQL
‚îú‚îÄ‚îÄ init-db.js            # Script de inicializaci√≥n de BD
‚îú‚îÄ‚îÄ package.json          # Dependencias y scripts npm
‚îú‚îÄ‚îÄ server.js             # Servidor Express y rutas API
‚îî‚îÄ‚îÄ README.MD             # Este archivo
```

---

## üóÑÔ∏è Esquema de Base de Datos

### Tabla: `rates`
Almacena las tarifas del estacionamiento.

| Campo | Tipo | Descripci√≥n |
|-------|------|-------------|
| `id` | INT | ID autoincremental |
| `base_cost` | DECIMAL(10,2) | Costo base |
| `minute_cost` | DECIMAL(10,2) | Costo por minuto |
| `is_active` | BOOLEAN | Si est√° activa |
| `created_at` | TIMESTAMP | Fecha de creaci√≥n |

### Tabla: `parking_sessions`
Registra las sesiones de estacionamiento.

| Campo | Tipo | Descripci√≥n |
|-------|------|-------------|
| `id` | INT | ID autoincremental |
| `plate` | VARCHAR(20) | Placa del veh√≠culo |
| `spot_id` | INT | ID de la plaza |
| `entry_time` | TIMESTAMP | Hora de entrada |
| `exit_time` | TIMESTAMP | Hora de salida |
| `total_cost` | DECIMAL(10,2) | Costo total |
| `total_time_minutes` | INT | Tiempo total en minutos |
| `status` | ENUM | `active` o `completed` |

### Tabla: `entry_queue`
Cola de espera de veh√≠culos.

| Campo | Tipo | Descripci√≥n |
|-------|------|-------------|
| `id` | INT | ID autoincremental |
| `plate` | VARCHAR(20) | Placa del veh√≠culo |
| `arrival_time` | TIMESTAMP | Hora de llegada |
| `status` | ENUM | `waiting` o `assigned` |

### Tabla: `parking_spots`
Estado de las plazas de estacionamiento.

| Campo | Tipo | Descripci√≥n |
|-------|------|-------------|
| `id` | INT | ID de la plaza |
| `is_occupied` | BOOLEAN | Si est√° ocupada |
| `current_vehicle_plate` | VARCHAR(20) | Placa del veh√≠culo actual |
| `last_status_change` | TIMESTAMP | √öltima actualizaci√≥n |

---

## üîß Soluci√≥n de Problemas

### Error: "Cannot connect to MySQL"
- Verifica que MySQL est√© corriendo
- Confirma las credenciales en `.env`
- Aseg√∫rate de que la base de datos `parking_system` exista

### Error: "Port 3001 already in use"
- Cambia el puerto en `.env` a otro disponible (ej: `PORT=3002`)

### Error: "MQTT connection failed"
- Verifica las credenciales de HiveMQ en `.env`
- Confirma que el broker MQTT est√© accesible

---

## üë• Contribuci√≥n

1. Haz un fork del proyecto
2. Crea una rama para tu feature (`git checkout -b feature/nueva-funcionalidad`)
3. Commit tus cambios (`git commit -m 'Agregar nueva funcionalidad'`)
4. Push a la rama (`git push origin feature/nueva-funcionalidad`)
5. Abre un Pull Request

---

## üìÑ Licencia

ISC

---

## üìû Contacto

Para preguntas o soporte, contacta al equipo de desarrollo.
